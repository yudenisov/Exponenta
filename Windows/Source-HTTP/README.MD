Создание инсталляционного модуля стайлера Exponenta
===================================================

Новая редакция
==============

В настоящей редакции в качестве подготовки инсталлируемого модуля
используется программа Inno Setup. Чтобы с его помощью скомпилировать
модуль, необходимо:

-   Установить из менеджера пакетов Chocolatey программу Inno Setup.
-   В любом файле с исходными текстами плагинов двойным щелчком открыть
    файл с расширением \*.iss.
-   В этом файле найти следующий фрагмент в секции \[Setup\]

<!-- -->

    Output=no
    OutputDir=d:\yudenisov\Distrib
    OutputBaseFilename=ExponentaHTTPStylerMainFiles151SetupRePack

-   Заменить их своими значениями. О правильном задании параметров
    смотри справку по программе Inno Setup.
-   Скомпилируйте исходный код, затем скопируйте получившийся
    инсталлятор в папку с установочными файлами стайлера (например, в
    этот каталог).
-   Бинго! Автор предупредительно не делает этого, чтобы его не обвинили
    в распространении вредоносных программ.

Старая редакция
===============

Для создания самораспаковывающихся инсталляционных модулей из исходных
кодов стайлера «Exponenta» используется свободно распространяемый
архиватор для Windows — 7zip.

Программа 7zip предлагает собственные средства создания и распаковки
архивов дистрибутивов, которые отличаются:

1.  Высокой степенью компрессии;
2.  Возможностью выполнения ряда задач после извлечения архива.

Создание дистрибутива включает в себя несколько этапов:

1.  Отладка исходного кода стайлера на тестовых примерах;
2.  Создание 7zip архива исходных кодов стайлера и плагинов (с
    расширением 7z, по-отдельности);
3.  Преобразование этих 7z архивов в самораспаковывающиеся SFX архивы с
    расширением exe;
4.  Написание кода для проверки установки, установки и постобработки
    (конфигурирования) установленного стайлера.

По этому алгоритму создаются все версии дистрибутивов и плагинов
стайлера.

Подготовка архива 7zip
----------------------

Для начала подготовим архивный файл 7Zip, который мы будем дальше
преобразовывать. Для этого:

1.  Щёлкните правой кнопкой мыши на каталоге, который Вы хотите
    заархивировать.
2.  В контекстном меню выберите «7zip &gt;» -&gt; «Добавить к архиву…».
3.  Откроется диалоговое окно, в котором сначала нужно выбрать
    месторасположение и имя архива.
4.  Затем укажите следующие опции:
5.  «Формат архива»: *7z*;
6.  «Уровень сжатия»: *Ультра*;
7.  «Метод сжатия»: *LZMA*;
8.  «Размер словаря»: *«32 MB»*;
9.  «Размер слова»: *64*;
10. «Размер блока»: *«По размеру файла»*;
11. «Число потоков»: *1*;
12. «Режим изменения»: *«Добавить и заменить»*;
13. «Пути к файлам»: *«Относительные пути»*;
14. Остальные опции оставить *незаполненными*;
15. Снять все флажки;
16. Нажать кнопку: «Ok».
17. После этого архив будет создан. Бинго!

Для основного файла стайлера Exponenta исходным каталогом будет
подкаталог pub1 текущего каталога, а именем архива — Exponenta.7z

Как создать самораспаковывающийся архив инсталлятора средствами 7zip
====================================================================

К сожалению, из стандартной поставки дистрибутива исчез модуль,
ответственный за «тихую» распаковку и установку дистрибутива. То есть
всегда теперь присутствует полоса прогресса распаковки и возможность
прервать распаковку и установку в любое время. Это не всегда оптимально,
например, при установке системных компонентов или «зловредов». К
счастью, существует сторонние модули, решающие эту проблему.

Установка дополнительных модулей 7zip
-------------------------------------

Для начала надо скачать и установить модуль, позволяющий организовать
«тихую» распаковку и установку программ путём создания соответствующего
SFX архива. Для этого нужно скачать программный продукт по ссылке:
<https://sourceforge.net/projects/s-zipsfxbuilder/>. После этого нужно
запустить инсталлятор, согласится с опциями по умолчанию и установить
пакет. В результате в каталоге %ProgramFiles% у вас появится каталог «7z
SFX Builder», в котором нас больше всего интересуют справочное
руководство 7zSD\_RU.chm и подкаталог с дополнительными расширениями
«3rdParty\\Modules». Из последнего мы будем брать модули для создания
самораспаковывающегося SFX архива из архива 7zip.

Подготовка файла конфигурации SFX
---------------------------------

1.  Скопируйте 7zip файл с архивом в новую папку;
2.  Скопируйте файл **«7zsd\_LZMA.sfx»** из каталога
    `"C:\Program Files (x86)\7z SFX Builder\3rdParty\Modules"` в эту же
    папку.
3.  Запустите программу «7z SFX Builder»;
4.  На первой вкладке отметьте опции: *«Перезаписывать все файлы»,
    «Скрыть все окна интерфейса»,* «Путь извлечения» — переменную или
    реальный каталог инсталляции пакетов;
5.  Перейдите на вкладку «SFX»;
6.  Выберите 7z архив в папке и установите флажок: «Добавить путь в файл
    конфигурации»;
7.  Выберите LZMA модуль в папке и установите флажок: «Добавить путь в
    файл конфигурации»;
8.  Выберите путь и имя SFX архива (с расширением \*.exe) и установите
    флажок: «Добавить путь в файл конфигурации»;
9.  Нажмите кнопку «Сохранить как» на панели инструментов программы и
    сохраните файл конфигурации под именем *«config.txt»* в папку с 7zip
    архивом программы. В дальнейшем вы можете не выполнять пункты: 1-9,
    а просто открыть этот файл кнопкой «Открыть» на панели инструментов;
10. Нажмите кнопку: *«Создать SFX»*;
11. Бинго!

Файл SFX архива создан. Теперь, если запустить его, он ничего не
покажет, а после завершения распаковки откроется распакованная из архива
папка.

Остальные вкладки автор не рекомендует заполнять, поскольку их
корректная работа не гарантируется.

В качестве пути извлечения файлов в пункте 4 надо указать системную
переменную %SystemDrive%. В этом случае иерархия каталогов будет
начинаться с корневого каталога диска C:.

Конфигурирование стайлера Exponenta
===================================

После создания файла установщика необходимо запустить конфигурационные
файлы, осуществляющие следующее:

1.  Проверка необходимости инсталляции (путём проверки существования
    каталога C:\pub1);
2.  Регистрацию в системе переменных Hacker\_User, Hacker\_Pass,
    Hacker\_host1, Hacker\_host2, PUB1, и добавление в переменную Path
    пути %PUB1%;
3.  Регистрация в планировщике задач заданий, связанных с файлами
    onsysload.bat, user\_hourly1.bat, user\_dayly1.bat,
    user\_onstart.bat таким способом, чтобы они выполнялись для всех
    пользователей системы в указанный промежуток времени;
4.  Создание пользователя с правами администратора для этого;
5.  Установка дополнительных плагинов и пакетов для функционирования
    стайлера.

В стандартный набор плагинов входит обязательный плагин «Hidden\_Start»,
без которого не будет нормально работать планировщик задач, пакет
«Chocolatey» для установки обязательных модулей wget и curl,
настоятельно рекомендуемые плагины «Elevation» и «duck» для облегчения
удалённого управления компьютером жертвы.

Как основные модули стайлера, так и его плагины не относятся к вирусам и
потенциально нежелательным программам и поэтому не опознаются
антивирусными программами. Стайлер эксплуатирует общую уязвимость стека
протоколов TCP/IP, которая была заложена в него на этапе разработки
Интернета в 80-х годах XX века, и никогда не будет исправлена по
определению. Этот стайлер может быть обнаружен только программами аудита
системы и отслеживания проникновений, а также, в меньшей степени,
сниферами трафика и аппаратными сетевыми фильтрами. Использование
брандмауэров для предотвращения заражения бесполезно, как и антивирусов.
Самой же лучшей защитой будет высокая корпоративная культура работы с
входящими сообщениями в организации.
